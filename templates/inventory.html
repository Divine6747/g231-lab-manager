<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G231 Lab Manager</title>
    <script src="https://kit.fontawesome.com/75b24b3695.js" crossorigin="anonymous"></script>
    <style>
        /* --- MODERN & TIDY STYLING --- */
        * { box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        
        .container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; max-width: 1600px; margin-left: auto; margin-right: auto; }
        
        h2, h3 { margin-top: 0; color: #1a1a1a; font-weight: 600; font-size: 1.25rem; }

        /* Form Sections */
        .form-section { border-radius: 10px; padding: 20px; border: 1px solid #e1e4e8; }
        .bg-add { background-color: #f6fffa; border-color: #d1e7dd; }
        .bg-manage { background-color: #f8fbff; border-color: #cfe2ff; }
        .bg-tools { background-color: #fffdf5; border-color: #fff3cd; }

        .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; font-size: 0.9rem; }
        .btn-add { background-color: #0d6efd; color: white; }
        .btn-save { background-color: #198754; color: white; padding: 8px 12px; }
        .btn-save:hover { background-color: #157347; transform: translateY(-1px); }
        .btn-delete { color: #dc3545; background: none; border: none; padding: 8px; border-radius: 6px; }
        .btn-delete:hover { background: #fee2e2; }

        .form-row { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .form-col { flex: 1; min-width: 180px; }
        label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 6px; color: #64748b; text-transform: uppercase; }
        
        /* Tidy Ghost Inputs */
        .form-input, .row-input { 
            width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; transition: all 0.2s;
        }
        .row-input { border-color: transparent; background: transparent; }
        .row-input:focus, .row-input:hover { background: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Sticky Grid Design */
        .inventory-grid { width: 100%; border-collapse: separate; border-spacing: 0; }
        .grid-header { 
            display: flex; 
            background: #f8fafc; 
            border-bottom: 2px solid #e2e8f0; 
            padding: 12px 10px; 
            position: sticky; 
            top: 0; 
            z-index: 10;
            font-weight: 700;
            color: #475569;
        }
        .grid-row { display: flex; border-bottom: 1px solid #f1f5f9; padding: 8px 10px; align-items: center; transition: background 0.1s; }
        .grid-row:hover { background-color: #f8fafc; }
        .grid-row.hidden { display: none; }
        .grid-cell { padding: 4px 6px; flex: 1; min-width: 0; }
        
        /* Column Widths */
        .col-check { flex: 0 0 45px; }
        .col-zone { flex: 0 0 110px; }
        .col-power { flex: 0 0 100px; }
        .col-actions { flex: 0 0 130px; text-align: right; display: flex; gap: 5px; justify-content: flex-end; }

        /* Mobile Adjustments */
        @media (max-width: 1024px) {
            .grid-header { display: none; }
            .grid-row { flex-direction: column; align-items: stretch; border-bottom: 6px solid #f1f5f9; padding: 20px; }
            .grid-cell { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f8fafc; }
            .grid-cell::before { content: attr(data-label); font-weight: 700; width: 140px; color: #64748b; font-size: 0.75rem; }
            .col-check, .col-zone, .col-power, .col-actions { flex: 1; }
        }

        .column-tag { background: #eff6ff; color: #1e40af; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; border: 1px solid #dbeafe; margin: 2px; }
    </style>
</head>
<body>

    <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin:0;"><i class="fa-solid fa-server" style="color:#3b82f6;"></i> Lab Inventory Systems</h2>
        <div style="display: flex; gap: 10px;">
            <a href="/download_backup" class="btn" style="background-color: #4b5563; color: white;"><i class="fa-solid fa-database"></i> Backup</a>
            <a href="/download_csv" class="btn" style="background-color: #10b981; color: white;"><i class="fa-solid fa-file-export"></i> CSV</a>
            <button type="button" class="btn" id="saveAllBtn" style="background-color: #6366f1; color: white;"><i class="fa-solid fa-cloud-arrow-up"></i> Save All</button>
        </div>
    </div>

    <div class="container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; background: transparent; padding: 0; box-shadow: none;">
        
        <div class="form-section bg-manage">
            <h3><i class="fa-solid fa-table-columns"></i> Manage Columns</h3>
            <form action="/add_column" method="POST" class="form-row">
                <input type="text" name="column_name" class="form-input" style="flex:2" placeholder="Field Name" required>
                <select name="column_type" class="form-input" style="flex:1">
                    <option value="TEXT">Text</option>
                    <option value="INTEGER">Number</option>
                </select>
                <button type="submit" class="btn btn-add"><i class="fa-solid fa-plus"></i></button>
            </form>
            <div style="max-height: 60px; overflow-y: auto;">
                {% for col in custom_columns %}
                <span class="column-tag">{{ col[1] or col[0] }} 
                    <a href="/delete_column/{{ col[0] }}" onclick="return confirm('Delete column?')" style="color:#ef4444;"><i class="fa-solid fa-xmark"></i></a>
                </span>
                {% endfor %}
            </div>
        </div>

        <div class="form-section bg-tools">
            <h3><i class="fa-solid fa-bolt"></i> Bulk Actions</h3>
            <div class="form-row">
                <div style="flex:1;">
                    <label>Move to Zone</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="text" form="bulkForm" name="new_zone" class="form-input" placeholder="Zone">
                        <button type="submit" form="bulkForm" class="btn" style="background:#f59e0b; color:white;"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
                <div style="flex:1;">
                    <label>Selection</label>
                    <button type="submit" form="bulkForm" name="action" value="delete" class="btn" style="background:#ef4444; color:white; width: 100%;" onclick="return confirm('Delete selected?')"><i class="fa-solid fa-trash-can"></i> Delete</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container bg-add form-section">
        <h3><i class="fa-solid fa-circle-plus"></i> Add New Lab Asset</h3>
        <form action="/add_item" method="POST">
            <div class="form-row">
                <div class="form-col"><label>Zone</label><input type="text" name="zone" class="form-input" required></div>
                <div class="form-col"><label>Item Name</label><input type="text" name="name" class="form-input" required></div>
                <div class="form-col"><label>Identifier</label><input type="text" name="id_val" class="form-input"></div>
                <div class="form-col"><label>Amps</label><input type="number" step="0.1" name="power" class="form-input"></div>
            </div>
            <button type="button" id="toggleCustomColumns" class="btn" style="background-color: #94a3b8; color: white; margin-bottom:15px;"><i class="fa-solid fa-layer-group"></i> Toggle Custom Fields</button>
            <div id="customFieldsSection" style="display: none; padding: 15px; border: 1px dashed #cbd5e1; border-radius: 8px; margin-bottom: 15px;">
                <div class="form-row">
                    {% for col_name, display_name, col_type in custom_columns %}
                    <div class="form-col">
                        <label>{{ display_name or col_name }}</label>
                        <input type="text" name="{{ col_name }}" class="form-input">
                    </div>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-add" style="width: 100%; justify-content: center;"><i class="fa-solid fa-plus"></i> Add Asset</button>
        </form>
    </div>

    <div class="container" style="padding: 15px 25px;">
        <div class="form-row" style="margin-bottom:0; align-items: center;">
           <div style="flex: 3; position: relative;" class="search-wrapper">
                <i class="fa-solid fa-magnifying-glass" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8;"></i>
                <input type="text" id="globalSearch" class="form-input" placeholder="Global Search..." style="padding-left: 35px;">
            </div>
            <div style="width: 160px;">
                <select id="zoneFilter" class="form-input">
                    <option value="">All Zones</option>
                </select>
            </div>
            <div style="width: 130px;">
                <select id="entriesLimit" class="form-input">
                    <option value="25" selected>25 rows</option>
                    <option value="50">50 rows</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container" style="padding: 0; overflow: visible;">
        <form action="/bulk_update" method="POST" id="bulkForm">
            <div class="inventory-grid">
                <div class="grid-header">
                    <div class="grid-cell col-check"><input type="checkbox" id="selectAll"></div>
                    <div class="grid-cell col-zone">Zone</div>
                    <div class="grid-cell" style="flex: 1.5;">Item Name</div>
                    <div class="grid-cell col-power">Amps</div>
                    <div class="grid-cell">Identifier</div>
                    {% for col_name, display_name, col_type in custom_columns %}
                    <div class="grid-cell">{{ display_name or col_name }}</div>
                    {% endfor %}
                    <div class="grid-cell col-actions">Action</div>
                </div>

                <div id="gridBody">
                    {% for item in items %}
                    <div class="grid-row" data-id="{{ item.id }}" data-zone="{{ item.zone }}">
                        <div class="grid-cell col-check">
                            <input type="checkbox" name="item_ids" value="{{ item.id }}" class="bulk-check">
                        </div>
                        <div class="grid-cell col-zone" data-label="Zone">
                            <input type="text" value="{{ item.zone }}" class="row-input" data-field="zone" data-id="{{ item.id }}">
                        </div>
                        <div class="grid-cell" style="flex: 1.5;" data-label="Item Name">
                            <input type="text" value="{{ item.item_name }}" class="row-input" data-field="item_name" data-id="{{ item.id }}">
                        </div>
                        <div class="grid-cell col-power" data-label="Amps">
                            <input type="number" step="0.1" value="{{ item.power_draw_amps }}" class="row-input" data-field="power_draw_amps" data-id="{{ item.id }}">
                        </div>
                        <div class="grid-cell" data-label="Identifier">
                            <input type="text" value="{{ item.identifier }}" class="row-input" data-field="identifier" data-id="{{ item.id }}">
                        </div>
                        {% for col_name, display_name, col_type in custom_columns %}
                        <div class="grid-cell" data-label="{{ display_name or col_name }}">
                            <input type="text" value="{{ item[col_name] or '' }}" class="row-input" data-field="{{ col_name }}" data-id="{{ item.id }}">
                        </div>
                        {% endfor %}
                        <div class="grid-cell col-actions">
                            <button type="button" class="btn btn-save save-row-btn" data-id="{{ item.id }}" title="Save changes">
                                <i class="fa-solid fa-floppy-disk"></i>
                            </button>
                            <a href="/delete/{{ item.id }}" class="btn-delete" onclick="return confirm('Delete?')"><i class="fa-solid fa-trash-can"></i></a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </form>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script>
        $(document).ready(function() {
            const modifiedRows = new Set();

            function applyFilters() {
                const search = $('#globalSearch').val().toLowerCase();
                const zone = $('#zoneFilter').val();
                const limit = $('#entriesLimit').val();
                let count = 0;

                $('.grid-row').each(function() {
                    const $row = $(this);
                    const text = $row.find('.row-input').map(function() { return $(this).val(); }).get().join(' ').toLowerCase();
                    const rowZone = $row.data('zone');

                    if (text.includes(search) && (zone === "" || rowZone == zone)) {
                        if (limit === "all" || count < parseInt(limit)) {
                            $row.removeClass('hidden'); count++;
                        } else { $row.addClass('hidden'); }
                    } else { $row.addClass('hidden'); }
                });
            }

            $('#globalSearch, #zoneFilter, #entriesLimit').on('input change', applyFilters);

            // Populate Filter
            const zones = new Set();
            $('.grid-row').each(function() { if($(this).data('zone')) zones.add($(this).data('zone')); });
            zones.forEach(z => $('#zoneFilter').append(`<option value="${z}">${z}</option>`));

            // Tracking and Saving
            $(document).on('input', '.row-input', function() {
                const id = $(this).data('id');
                modifiedRows.add(id);
                $(`.grid-row[data-id="${id}"]`).css('background-color', '#fffbeb');
                $(`.save-row-btn[data-id="${id}"]`).css('background-color', '#f59e0b');
            });

            $(document).on('click', '.save-row-btn', function() {
                saveRow($(this).data('id'), $(this));
            });

            function saveRow(id, $btn) {
                const formData = new FormData();
                formData.append('id', id);
                $(`.grid-row[data-id="${id}"] .row-input`).each(function() {
                    formData.append($(this).data('field'), $(this).val());
                });

                const originalHtml = $btn.html();
                $btn.html('<i class="fa-solid fa-spinner fa-spin"></i>').prop('disabled', true);
                
                $.ajax({
                    url: '/update', method: 'POST', data: formData, processData: false, contentType: false,
                    success: function() {
                        modifiedRows.delete(id);
                        $btn.html(originalHtml).prop('disabled', false).css('background-color', '');
                        $(`.grid-row[data-id="${id}"]`).css('background-color', '');
                    }
                });
            }

            $('#saveAllBtn').click(function() {
                if(modifiedRows.size === 0) return alert("No changes to save.");
                const promises = Array.from(modifiedRows).map(id => {
                    const formData = new FormData();
                    formData.append('id', id);
                    $(`.grid-row[data-id="${id}"] .row-input`).each(function() {
                        formData.append($(this).data('field'), $(this).val());
                    });
                    return $.ajax({ url: '/update', method: 'POST', data: formData, processData: false, contentType: false });
                });
                Promise.all(promises).then(() => location.reload());
            });

            $('#toggleCustomColumns').on('click', function() { $('#customFieldsSection').slideToggle(); });
            $('#selectAll').on('change', function() { $('.bulk-check:visible').prop('checked', this.checked); });
            applyFilters();
        });
    </script>
</body>
</html>
